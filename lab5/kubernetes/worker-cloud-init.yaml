#cloud-config
users:
  - name: ubuntu
    groups: sudo, docker
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL

package_update: true
package_upgrade: true

packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  - git
  - openssh-server
  - nfs-common

write_files:
  - path: /etc/modules-load.d/containerd.conf
    content: |
      overlay
      br_netfilter
    permissions: '0644'
    owner: root:root

  - path: /etc/sysctl.d/kubernetes.conf
    content: |
      net.bridge.bridge-nf-call-ip6tables = 1
      net.bridge.bridge-nf-call-iptables = 1
      net.ipv4.ip_forward = 1
    permissions: '0644'
    owner: root:root

  - path: /home/ubuntu/setup-worker.sh
    content: |
      #!/bin/bash
      set -euo pipefail

      export DEBIAN_FRONTEND=noninteractive

      echo "[TASK 1] Disable and turn off SWAP"
      sed -i '/swap/d' /etc/fstab
      swapoff -a

      echo "[TASK 2] Stop and Disable firewall"
      systemctl disable --now ufw >/dev/null 2>&1

      echo "[TASK 3] Enable and Load Kernel modules"
      modprobe overlay
      modprobe br_netfilter
      sysctl --system >/dev/null 2>&1

      echo "[TASK 4] Install containerd runtime"
      mkdir -p /etc/apt/keyrings
      curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
      echo \
        "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
        $(lsb_release -cs) stable" > /etc/apt/sources.list.d/docker.list
      apt-get update -qq >/dev/null
      apt-get install -qq -y containerd.io >/dev/null
      containerd config default > /etc/containerd/config.toml
      sed -i 's/SystemdCgroup \= false/SystemdCgroup \= true/g' /etc/containerd/config.toml
      systemctl restart containerd
      systemctl enable containerd >/dev/null

      echo "[TASK 5] Set up kubernetes repo"
      curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | gpg --dearmor -o /usr/share/keyrings/kubernetes-archive-keyring.gpg
      echo "deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main" | tee /etc/apt/sources.list.d/kubernetes.list

      echo "[TASK 6] Install Kubernetes components"
      apt-get update
      apt-get install -y kubelet kubeadm kubectl
      apt-mark hold kubelet kubeadm kubectl
      systemctl enable --now kubelet

      echo "[TASK 7] Wait for master node to be ready and join cluster"
      echo "Waiting for join command from master..."
      while [ ! -f /srv/join/joincluster.sh ]; do
        echo "Waiting for master to generate join command..."
        sleep 10
      done
      
      echo "Join command found, waiting a bit more for master to be fully ready..."
      sleep 30
      
      echo "Joining cluster..."
      bash /srv/join/joincluster.sh >> /root/join.log 2>&1

      echo "[TASK 8] Worker node setup complete!"
    permissions: '0755'
    owner: root:root

runcmd:
  - 'echo "172.16.16.100   master.example.com     master" >> /etc/hosts'
  - 'echo "172.16.16.101   worker1.example.com    worker1" >> /etc/hosts'
  - 'echo "172.16.16.102   worker2.example.com    worker2" >> /etc/hosts'
  - '/home/ubuntu/setup-worker.sh'



